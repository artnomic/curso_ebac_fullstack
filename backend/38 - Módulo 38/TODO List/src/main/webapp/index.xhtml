<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>Meu To-Do Semanal</title>
    <style>
        /* Estilo para tachado */
        .task-concluida {
            text-decoration: line-through;
            color: #555; /* Cor um pouco mais escura para contraste com verde */
        }
        /* NOVO: Estilo para fundo verde claro */
        .task-concluida-bg {
            background-color: #d4edda !important; /* Verde claro bootstrap success. !important para garantir */
            border-color: #c3e6cb !important;
        }

        .dia-coluna { min-height: 150px; padding: 5px; border: 1px dashed #ccc; }

        /* Link clicável para ABRIR o popup */
        .task-link {
            display: block; padding: 3px 6px; margin-bottom: 4px; border-radius: 3px;
            border: 1px solid #d9d9d9; background-color: #fff;
            cursor: pointer; /* Indica clicável */
            transition: background-color 0.2s ease; /* Transição suave */
        }
        .task-link:hover { background-color: #f5f5f5; text-decoration: underline;}

    </style>
</h:head>

<h:body>
    <h:form id="formPrincipal">
        <p:growl id="growl" showDetail="true" life="5000" redisplay="true"/>

        <p:panel header="Selecionar Semana">
            <h:panelGrid columns="3" cellpadding="5">
                <p:outputLabel for="seletorData" value="Selecione um dia da semana:"/>
                <p:calendar id="seletorData" value="#{semanaBean.dataSelecionada}" showOn="button" pattern="dd/MM/yyyy">
                    <p:ajax event="dateSelect" listener="#{semanaBean.carregarSemana}" update="@form"/>
                </p:calendar>
                <p:commandButton value="Recarregar" actionListener="#{semanaBean.carregarSemana}" update="@form" icon="pi pi-refresh"/>
            </h:panelGrid>
        </p:panel>
        <br/>

        <p:outputPanel id="painelSemana">
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">

                <p:panel header="#{semanaBean.headerSegunda}">
                    <p:outputPanel id="col-segunda" styleClass="dia-coluna">
                        <ui:repeat value="#{semanaBean.tarefasSegunda}" var="task">
                            <p:commandLink id="task-link"
                                           actionListener="#{semanaBean.selecionarTarefaParaEdicao(task)}"
                                           oncomplete="PF('dialogEditarTarefa').show()"
                                           update=":formEditarTarefa:dialogEditarTarefaContent"
                                           process="@this"
                                           styleClass="task-link #{task.concluida ? 'task-concluida task-concluida-bg' : ''}">
                                <h:outputText value="#{task.descricao}"/>
                            </p:commandLink>
                        </ui:repeat>
                    </p:outputPanel>
                    <p:commandButton icon="pi pi-plus" title="Adicionar Tarefa" oncomplete="PF('dialogNovaTarefa').show()" update=":formDialogNovaTarefa:painelDialog" actionListener="#{semanaBean.prepararNovaTarefa(semanaBean.inicioSemana.plusDays(0))}" process="@this" style="margin-top: 10px;"/>
                </p:panel>

                <p:panel header="#{semanaBean.headerTerca}">
                    <p:outputPanel id="col-terca" styleClass="dia-coluna">
                        <ui:repeat value="#{semanaBean.tarefasTerca}" var="task">
                            <p:commandLink id="task-link"
                                           actionListener="#{semanaBean.selecionarTarefaParaEdicao(task)}"
                                           oncomplete="PF('dialogEditarTarefa').show()"
                                           update=":formEditarTarefa:dialogEditarTarefaContent"
                                           process="@this"
                                           styleClass="task-link #{task.concluida ? 'task-concluida task-concluida-bg' : ''}">
                                <h:outputText value="#{task.descricao}"/>
                            </p:commandLink>
                        </ui:repeat>
                    </p:outputPanel>
                    <p:commandButton icon="pi pi-plus" title="Adicionar Tarefa" oncomplete="PF('dialogNovaTarefa').show()" update=":formDialogNovaTarefa:painelDialog" actionListener="#{semanaBean.prepararNovaTarefa(semanaBean.inicioSemana.plusDays(1))}" process="@this" style="margin-top: 10px;"/>
                </p:panel>

                <p:panel header="#{semanaBean.headerQuarta}">
                    <p:outputPanel id="col-quarta" styleClass="dia-coluna">
                        <ui:repeat value="#{semanaBean.tarefasQuarta}" var="task">
                            <p:commandLink id="task-link"
                                           actionListener="#{semanaBean.selecionarTarefaParaEdicao(task)}"
                                           oncomplete="PF('dialogEditarTarefa').show()"
                                           update=":formEditarTarefa:dialogEditarTarefaContent"
                                           process="@this"
                                           styleClass="task-link #{task.concluida ? 'task-concluida task-concluida-bg' : ''}">
                                <h:outputText value="#{task.descricao}"/>
                            </p:commandLink>
                        </ui:repeat>
                    </p:outputPanel>
                    <p:commandButton icon="pi pi-plus" title="Adicionar Tarefa" oncomplete="PF('dialogNovaTarefa').show()" update=":formDialogNovaTarefa:painelDialog" actionListener="#{semanaBean.prepararNovaTarefa(semanaBean.inicioSemana.plusDays(2))}" process="@this" style="margin-top: 10px;"/>
                </p:panel>

                <p:panel header="#{semanaBean.headerQuinta}">
                    <p:outputPanel id="col-quinta" styleClass="dia-coluna">
                        <ui:repeat value="#{semanaBean.tarefasQuinta}" var="task">
                            <p:commandLink id="task-link"
                                           actionListener="#{semanaBean.selecionarTarefaParaEdicao(task)}"
                                           oncomplete="PF('dialogEditarTarefa').show()"
                                           update=":formEditarTarefa:dialogEditarTarefaContent"
                                           process="@this"
                                           styleClass="task-link #{task.concluida ? 'task-concluida task-concluida-bg' : ''}">
                                <h:outputText value="#{task.descricao}"/>
                            </p:commandLink>
                        </ui:repeat>
                    </p:outputPanel>
                    <p:commandButton icon="pi pi-plus" title="Adicionar Tarefa" oncomplete="PF('dialogNovaTarefa').show()" update=":formDialogNovaTarefa:painelDialog" actionListener="#{semanaBean.prepararNovaTarefa(semanaBean.inicioSemana.plusDays(3))}" process="@this" style="margin-top: 10px;"/>
                </p:panel>

                <p:panel header="#{semanaBean.headerSexta}">
                    <p:outputPanel id="col-sexta" styleClass="dia-coluna">
                        <ui:repeat value="#{semanaBean.tarefasSexta}" var="task">
                            <p:commandLink id="task-link"
                                           actionListener="#{semanaBean.selecionarTarefaParaEdicao(task)}"
                                           oncomplete="PF('dialogEditarTarefa').show()"
                                           update=":formEditarTarefa:dialogEditarTarefaContent"
                                           process="@this"
                                           styleClass="task-link #{task.concluida ? 'task-concluida task-concluida-bg' : ''}">
                                <h:outputText value="#{task.descricao}"/>
                            </p:commandLink>
                        </ui:repeat>
                    </p:outputPanel>
                    <p:commandButton icon="pi pi-plus" title="Adicionar Tarefa" oncomplete="PF('dialogNovaTarefa').show()" update=":formDialogNovaTarefa:painelDialog" actionListener="#{semanaBean.prepararNovaTarefa(semanaBean.inicioSemana.plusDays(4))}" process="@this" style="margin-top: 10px;"/>
                </p:panel>

            </div> </p:outputPanel> </h:form> <h:form id="formDialogNovaTarefa">
    <p:dialog header="Adicionar Nova Tarefa" widgetVar="dialogNovaTarefa" modal="true" showEffect="fade" hideEffect="fade" resizable="false" closeOnEscape="true">
        <p:outputPanel id="painelDialog" style="min-width: 300px;">
            <p:outputPanel rendered="#{semanaBean.dataNovaTarefaFormatada != null}">
                <p>Adicionando tarefa para: <b><h:outputText value="#{semanaBean.dataNovaTarefaFormatada}"/></b></p>
                <h:panelGrid columns="2" cellpadding="5">
                    <p:outputLabel for="desc" value="Descrição:"/>
                    <p:inputText id="desc" value="#{semanaBean.novaTarefaDescricao}" required="true" requiredMessage="Descrição é obrigatória" style="width: 250px;"/>
                </h:panelGrid>
            </p:outputPanel>
            <p:outputPanel rendered="#{semanaBean.dataNovaTarefaFormatada == null}"><p>Erro: Dia não selecionado.</p></p:outputPanel>
        </p:outputPanel>
        <f:facet name="footer">
            <p:commandButton value="Salvar" actionListener="#{semanaBean.salvarNovaTarefa}" update=":formPrincipal @form" oncomplete="if (args &amp;&amp; !args.validationFailed) PF('dialogNovaTarefa').hide()"/>
            <p:commandButton value="Cancelar" type="button" onclick="PF('dialogNovaTarefa').hide()"/>
        </f:facet>
    </p:dialog>
</h:form>

    <h:form id="formEditarTarefa">
        <p:dialog header="Editar Tarefa" widgetVar="dialogEditarTarefa" modal="true" showEffect="fade" hideEffect="fade" resizable="false" closeOnEscape="true">
            <p:outputPanel id="dialogEditarTarefaContent" style="min-width: 350px;">
                <p:outputPanel rendered="#{semanaBean.tarefaSelecionada != null}">
                    <h:panelGrid columns="2" cellpadding="5">
                        <p:outputLabel value="Descrição:"/>
                        <h:outputText value="#{semanaBean.tarefaSelecionada.descricao}" style="font-weight: bold;"/>

                        <p:outputLabel for="concluidaCheck" value="Concluída:"/>
                        <p:selectBooleanCheckbox id="concluidaCheck" value="#{semanaBean.tarefaSelecionada.concluida}"/>

                        <p:outputLabel for="novaData" value="Mover para:"/>
                        <p:calendar id="novaData" value="#{semanaBean.novaDataParaTarefaSelecionada}" pattern="dd/MM/yyyy" required="true" requiredMessage="Selecione a nova data"/>
                    </h:panelGrid>
                </p:outputPanel>
                <p:outputPanel rendered="#{semanaBean.tarefaSelecionada == null}">
                    <p>Nenhuma tarefa selecionada.</p>
                </p:outputPanel>
            </p:outputPanel>

            <f:facet name="footer">
                <p:commandButton value="Salvar Alterações"
                                 actionListener="#{semanaBean.salvarEdicaoTarefa}"
                                 update=":formPrincipal @form"
                                 oncomplete="if (args &amp;&amp; !args.validationFailed) PF('dialogEditarTarefa').hide()"/>
                <p:commandButton value="Cancelar" type="button" onclick="PF('dialogEditarTarefa').hide()"/>
            </f:facet>
        </p:dialog>
    </h:form>

</h:body>
</html>